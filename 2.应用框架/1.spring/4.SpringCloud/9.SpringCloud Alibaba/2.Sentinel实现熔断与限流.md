[toc]

# Sentinel

[官网](https://github.com/alibaba/Sentinel) [中文]([https://github.com/alibaba/Sentinel/wiki/%E4%BB%8B%E7%BB%8D](https://github.com/alibaba/Sentinel/wiki/介绍))

## 是什么

轻量级的流量控制、熔断降级Java库

随着微服务的流行，服务和服务之间的稳定性变得越来越重要。Sentinel以流量为切入点，从流量控制、熔断降级、系统负载保护等多个维度保护服务的稳定性。

# 安装Sentinel控制台

**下载**   [sentinel-dashboard-1.7.2.jar](https://github.com/alibaba/Sentinel/releases/download/1.7.2/sentinel-dashboard-1.7.2.jar)

> https://github.com/alibaba/Sentinel/releases/tag/1.7.2  下载地址

sentinel组件由2部分构成

```
核心库 不依赖任何框架，能够运行于所有Java运行时环境，同时对Dubbo/Spring Cloud 等框架也有较好的支持。

前台 基于 Spring Boot开发， 打包后直接运行，不需要额外的Tomcat等应用容器.
```

**运行**

`java -jar ***.jar` 直接运行jar包



**访问Sentinel管理界面** 

http://localhost:8080

登录账号密码均为 sentinel

# 初始化演示工程

1. **启动Nacos8848**

2. **新建cloudalibaba-sentinel-service8401 **

   pom

   ```xml
     <dependencies>
       <dependency>
         <groupId>com.atguigu.springcloud</groupId>
         <artifactId>cloud-api-commons</artifactId>
         <version>${project.version}</version>
       </dependency>
       <dependency>
         <groupId>com.alibaba.cloud</groupId>
         <artifactId>spring-cloud-starter-alibaba-nacos-discovery</artifactId>
       </dependency>
       <dependency>
         <groupId>com.alibaba.csp</groupId>
         <artifactId>sentinel-datasource-nacos</artifactId>
       </dependency>
       <dependency>
         <groupId>com.alibaba.cloud</groupId>
         <artifactId>spring-cloud-starter-alibaba-sentinel</artifactId>
       </dependency>
       <dependency>
         <groupId>org.springframework.cloud</groupId>
         <artifactId>spring-cloud-starter-openfeign</artifactId>
       </dependency>
       <dependency>
         <groupId>org.springframework.boot</groupId>
         <artifactId>spring-boot-starter-web</artifactId>
       </dependency>
       <dependency>
         <groupId>org.springframework.boot</groupId>
         <artifactId>spring-boot-starter-actuator</artifactId>
       </dependency>
       <dependency>
         <groupId>cn.hutool</groupId>
         <artifactId>hutool-all</artifactId>
         <version>4.6.3</version>
       </dependency>
       <dependency>
         <groupId>org.projectlombok</groupId>
         <artifactId>lombok</artifactId>
         <optional>true</optional>
       </dependency>
       <dependency>
         <groupId>org.springframework.boot</groupId>
         <artifactId>spring-boot-starter-test</artifactId>
         <scope>test</scope>
       </dependency>
     </dependencies>
     <build>
       <plugins>
         <plugin>
           <groupId>org.springframework.boot</groupId>
           <artifactId>spring-boot-maven-plugin</artifactId>
         </plugin>
       </plugins>
     </build>
   ```

   application.properties

   ```properties
   server.port=8301
   spring.application.name=cloudalibaba-sentinel-service
   spring.cloud.nacos.discovery.server-addr=localhost:8848
   # 配置Sentinel dashboard地址
   spring.cloud.sentinel.transport.dashboard=localhost:8080
   # 默认8719端口，假如被占用会从8719开始依次+1扫描，直至找到未被 占用的端口
   spring.cloud.sentinel.transport.port=8719
   management.endpoints.web.exposure.exclude=*
   ```

   主启动类

   ```java
   @SpringBootApplication
   @EnableDiscoveryClient
   public class MainApp8401 {
   
     public static void main(String[] args) {
       SpringApplication.run(MainApp8401.class, args);
     }
   }
   ```

   业务类FlowLimitController

   ```java
   @RestController
   public class FlowLimitController {
   
     @GetMapping("/testA")
     public String testA() {
       return "---------testA";
     }
   
     @GetMapping("/testB")
     public String testB() {
       return "---------testB";
     }
   }
   ```

3. 启动 sentinel8080

4. 启动微服务8401

5. 启动8401微服务后查看sentinel控制台

   > 一开始空空如也，什么都没有，Sentinel采用的懒加载说明，执行一次访问http://localhost:8401/testA 再次查看就有内容了。



# 流控规则 

## 基本介绍

在流控规则中新增流控规则：（参数说明）

- 资源名： 唯一名称，默认请求路径
- 针对来源：Sentinel可以针对调用者进行限流，填写微服务名，默认default（不区分来源）
- 阈值类型/单机阈值
  - QPS（每秒钟的请求数量）：当调用该app的QPS达到阈值时，进行限流。
  - 线程数：当调用该api的线程数达到阈值时，进行限流。
- 是否集群：不需要群集
- 流控模式
  - 直接：api达到限流条件时，直接限流。
  - 关联：当关联的资源达到阈值时，就限流自己。
  - 链路：只记录链路上的流量（指定资源从入口资源进来的流量，如果达到阈值，就进行限流）api级别的针对来源。
- 流控效果：
  - 快速失败：直接失败，抛异常
  - Warm Up:根据codeFactor（冷加载因子，默认3 ）的值，从阈值/codeFactor，经过预热时长，才达到设置的QPS阈值。
  - 排队等待：均速排队，让请求均速通过，阈值类型必须设置为QPS，否则无效。

## 流控模式

### 直接失败（默认的）

### 预热

阈值除以coldeFactor(默认为3)，经过预热时长后才会达到阈值。

规则参数：阈值类型：QPS 阈值：9 流控模式：直接 流控效果：warm up 预热时长 10秒。

最后的效果就是，当请求到达时，一开始实际的QPS值为 9/3为3。经过10的预热才会达到9. 

## 排队等待



### 直接模式-QPS-快速失败

`簇点链路`>`+流控`>`QPS`>`单机阈值1(1代表每秒最多1次)`>`直接失败`

规定在一秒内阈值达到设置值时，不进行处理。

### 直接模式-线程数-快速失败

`簇点链路`>`+流控`>`线程数`>`单机阈值1(1代表每秒最多1次)`>`直接失败`

规定在一秒内只能有规定数量的线程在处理业务，如果超出则直接失败。

### 关联模式-QPS-快速失败

设置  /testA的关联资源为testB,QPS阈值1，这样当，testB阈值超出1时就限流/testA的Rest访问地址。



## 流控效果



# 降级规则

# 热点key限流

# SentinelResource

# 服务熔断功能

# 规则持久化

